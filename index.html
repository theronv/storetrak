<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f0f">
<title>STORETRAK</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f0f0f; --surface: #181818; --surface2: #222; --surface3: #2a2a2a;
  --border: #2e2e2e; --border-bright: #484848; --accent: #f0a500;
  --accent-dim: rgba(240,165,0,0.13); --accent-border: rgba(240,165,0,0.32);
  --text: #ece8e0; --text-muted: #787878; --text-dim: #444;
  --green: #4caf78; --red: #c95c5c; --tab-h: 64px; --header-h: 54px;
  --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-top: env(safe-area-inset-top, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Barlow', sans-serif; -webkit-font-smoothing: antialiased; font-size: 15px; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header { position: fixed; top: 0; left: 0; right: 0; height: calc(var(--header-h) + var(--safe-top)); padding-top: var(--safe-top); background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 12px; z-index: 50; }
.logo { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; color: var(--accent); letter-spacing: 3px; flex-shrink: 0; }
.header-search { flex: 1; position: relative; }
.header-search input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px 9px 34px; border-radius: 8px; outline: none; font-family: 'Barlow'; }
.search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }

.app-body { position: fixed; top: calc(var(--header-h) + var(--safe-top)); left: 0; right: 0; bottom: calc(var(--tab-h) + var(--safe-bottom)); overflow-y: auto; -webkit-overflow-scrolling: touch; }

/* ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ */
.tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--tab-h) + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: var(--surface); border-top: 1px solid var(--border); display: flex; z-index: 50; }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; cursor: pointer; }
.tab.active .tab-icon, .tab.active .tab-label { color: var(--accent); }
.tab-icon { font-size: 20px; color: var(--text-dim); line-height: 1; }
.tab-label { font-family: 'Space Mono', monospace; font-size: 9px; text-transform: uppercase; color: var(--text-dim); }

.page { display: none; padding: 14px; }
.page.active { display: block; }

/* ‚îÄ‚îÄ CARDS & CHIPS ‚îÄ‚îÄ */
.tote-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
.tote-card-head { display: flex; align-items: center; gap: 8px; padding: 12px 14px; background: var(--surface2); border-bottom: 1px solid var(--border); }
.tote-badge { font-family: 'Space Mono'; font-size: 11px; color: var(--accent); background: var(--accent-dim); border: 1px solid var(--accent-border); padding: 3px 7px; border-radius: 4px; }
.tote-name { font-weight: 600; flex: 1; }
.tote-loc { padding: 8px 14px; font-size: 11px; color: var(--text-muted); display: flex; justify-content: space-between; background: var(--surface2); border-bottom: 1px solid var(--border); }

.items-wrap { display: flex; flex-wrap: wrap; gap: 6px; padding: 12px; }
.item-chip { display: inline-flex; align-items: center; gap: 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px; font-size: 13px; cursor: pointer; }
.chip-dot { width: 7px; height: 7px; border-radius: 50%; }
.chip-action { background: none; border: none; color: var(--text-dim); padding-left: 5px; cursor: pointer; font-size: 14px; }

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
.stat-num { font-family: 'Space Mono'; font-size: 28px; color: var(--accent); font-weight: 700; }
.stat-lbl { font-family: 'Space Mono'; font-size: 9px; color: var(--text-muted); text-transform: uppercase; }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; }
.overlay.open { display: flex; }
.sheet { background: var(--surface); border-top: 1px solid var(--border-bright); border-radius: 16px 16px 0 0; padding: 20px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.2s ease-out; }
.field { margin-bottom: 12px; }
.field label { display: block; font-family: 'Space Mono'; font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
.field input, .field select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 8px; font-family: 'Barlow'; outline: none; }
.sheet-btns { display: flex; gap: 10px; margin-top: 20px; }
.btn-primary { background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: 700; flex: 1; cursor: pointer; }

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@media (min-width: 640px) { .app-body, .tab-bar { max-width: 600px; margin: 0 auto; left: 0; right: 0; } .overlay { align-items: center; justify-content: center; } .sheet { max-width: 450px; border-radius: 16px; } }
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">STRTRAK</div>
  <div class="header-search">
    <span class="search-icon">‚åï</span>
    <input id="searchInput" placeholder="Search inventory..." autocomplete="off">
  </div>
  <div class="status-wrap"><div id="statusDot" class="status-dot"></div></div>
</header>

<div class="app-body" id="appBody">
  <div class="page active" id="pageInbox">
    <div class="page-hd"><div><div class="page-title">Inbox</div><div id="inboxSubtitle" class="page-sub">UNSORTED</div></div></div>
    <div class="tote-card" style="border-color: var(--accent-border); margin-bottom:16px;">
      <div class="items-wrap" style="padding:12px; display:flex; gap:6px;">
        <input class="field" id="inboxInput" style="flex:1; margin-bottom:0" placeholder="Quick scan item..." onkeydown="if(event.key==='Enter') addInboxItem()">
        <select id="inboxCat" style="width:100px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:0 5px;">
          <option value="other">Other</option><option value="tools">Tools</option><option value="electronics">Electronics</option>
        </select>
        <button class="btn-primary" style="flex:none; padding:0 15px;" onclick="addInboxItem()">ADD</button>
      </div>
    </div>
    <div id="inboxList" class="items-wrap"></div>
  </div>

  <div class="page" id="pageTotes"><div id="totePageContent"></div></div>

  <div class="page" id="pageRooms">
    <div class="page-hd"><div><div class="page-title">Rooms</div><div id="roomsSubtitle" class="page-sub"></div></div><button class="btn-primary" style="flex:none" onclick="openRoomSheet()">+ Room</button></div>
    <div id="roomsGrid" style="display:grid; gap:8px;"></div>
  </div>

  <div class="page" id="pageStats">
    <div class="page-hd"><div class="page-title">Overview</div></div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num" id="sRooms">-</div><div class="stat-lbl">Rooms</div></div>
      <div class="stat-card"><div class="stat-num" id="sTotes">-</div><div class="stat-lbl">Totes</div></div>
      <div class="stat-card"><div class="stat-num" id="sItems">-</div><div class="stat-lbl">Items</div></div>
      <div class="stat-card"><div class="stat-num" id="sCats">-</div><div class="stat-lbl">Categories</div></div>
    </div>
    <div class="cat-breakdown" id="catBreakdown"></div>
  </div>
</div>

<nav class="tab-bar">
  <div class="tab active" id="tabInbox" onclick="switchTab('inbox')"><span class="tab-icon">üì•</span><span class="tab-label">Inbox</span></div>
  <div class="tab" id="tabTotes" onclick="switchTab('totes')"><span class="tab-icon">üì¶</span><span class="tab-label">Totes</span></div>
  <div class="tab" id="tabRooms" onclick="switchTab('rooms')"><span class="tab-icon">üè†</span><span class="tab-label">Rooms</span></div>
  <div class="tab" id="tabAdd" onclick="openToteSheet()"><span class="tab-icon" style="color:var(--accent)">+</span><span class="tab-label" style="color:var(--accent)">Tote</span></div>
  <div class="tab" id="tabStats" onclick="switchTab('stats')"><span class="tab-icon">üìä</span><span class="tab-label">Stats</span></div>
</nav>

<div class="overlay" id="detailOverlay">
  <div class="sheet">
    <h3 id="detHeader" style="margin-bottom:15px; font-family:'Barlow Condensed'; color:var(--accent)">ITEM DETAIL</h3>
    <div class="field"><label>Item Name</label><input id="detName"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <div class="field"><label>Make</label><input id="detMake"></div>
      <div class="field"><label>Model</label><input id="detModel"></div>
      <div class="field"><label>Year</label><input id="detYear"></div>
      <div class="field"><label>Value ($)</label><input id="detValue"></div>
    </div>
    <div class="field"><label>Image URL</label><input id="detImg"></div>
    <div class="sheet-btns">
      <button class="btn-primary" style="background:var(--surface2); color:var(--text)" onclick="closeSheet('detailOverlay')">Close</button>
      <button class="btn-primary" onclick="saveItem()">Save Changes</button>
    </div>
  </div>
</div>

<div class="overlay" id="moveOverlay">
  <div class="sheet">
    <h3 style="margin-bottom:15px; font-family:'Barlow Condensed'">MOVE TO TOTE</h3>
    <div class="field"><label>Destination Tote</label><select id="moveDest"></select></div>
    <div class="sheet-btns">
      <button class="btn-primary" style="background:var(--surface2); color:var(--text)" onclick="closeSheet('moveOverlay')">Cancel</button>
      <button class="btn-primary" onclick="confirmMove()">Confirm Move</button>
    </div>
  </div>
</div>

<div class="overlay" id="roomOverlay">
  <div class="sheet">
    <h3 style="margin-bottom:15px; font-family:'Barlow Condensed'">ADD ROOM</h3>
    <div class="field"><label>Room Name</label><input id="roomNameInput"></div>
    <div class="field"><label>Short Code</label><input id="roomCodeInput" maxlength="4"></div>
    <div class="sheet-btns"><button class="btn-primary" onclick="closeSheet('roomOverlay')">Cancel</button><button class="btn-primary" onclick="submitRoom()">Add Room</button></div>
  </div>
</div>

<div class="overlay" id="toteOverlay">
  <div class="sheet">
    <h3 style="margin-bottom:15px; font-family:'Barlow Condensed'">ADD TOTE</h3>
    <div class="field"><label>Room</label><select id="toteRoomSel"></select></div>
    <div class="field"><label>Tote Name</label><input id="toteNameInput"></div>
    <div class="field"><label>Location</label><input id="toteShelfInput"></div>
    <div class="sheet-btns"><button class="btn-primary" onclick="closeSheet('toteOverlay')">Cancel</button><button class="btn-primary" onclick="submitTote()">Create Tote</button></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kwhawubarlocjluujurq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_dByd8AVDaZEWIoFkpAYXvw_-6HDtTfi';

const CATEGORIES = { tools: {label: 'Tools', color: '#e05c00'}, electronics: {label: 'Electronics', color: '#4a9eff'}, other: {label: 'Other', color: '#555'} };

let rooms = [], totes = [], items = [], activeItemId = null;

async function sb(method, path, body) {
  const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, { method, headers, body: body ? JSON.stringify(body) : undefined });
  return res.json();
}

async function loadAll() {
  [rooms, totes, items] = await Promise.all([sb('GET', 'rooms?order=name'), sb('GET', 'totes?order=id'), sb('GET', 'items?order=name')]);
  renderAll();
}

function switchTab(tab) {
  document.querySelectorAll('.tab, .page').forEach(el => el.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('page' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  renderAll();
}

async function addInboxItem() {
  const input = document.getElementById('inboxInput');
  const cat = document.getElementById('inboxCat').value;
  if (!input.value.trim()) return;
  const [item] = await sb('POST', 'items', { tote_id: null, name: input.value.trim(), category: cat });
  items.push(item);
  input.value = ''; input.focus();
  renderAll();
}

function renderAll() {
  // Inbox
  const inboxItems = items.filter(i => !i.tote_id);
  document.getElementById('inboxSubtitle').textContent = `${inboxItems.length} UNSORTED ITEMS`;
  document.getElementById('inboxList').innerHTML = inboxItems.map(i => `
    <div class="item-chip" onclick="openDetail('${i.id}')">
      <span class="chip-dot" style="background:${(CATEGORIES[i.category]||CATEGORIES.other).color}"></span>
      ${i.name} <button class="chip-action" onclick="event.stopPropagation(); openMove('${i.id}')">üì¶</button>
    </div>
  `).join('');

  // Totes
  const toteList = document.getElementById('totePageContent');
  toteList.innerHTML = totes.map(t => {
    const tItems = items.filter(i => i.tote_id === t.id);
    return `<div class="tote-card">
      <div class="tote-card-head"><span class="tote-badge">${t.id}</span><span class="tote-name">${t.name}</span><span>${tItems.length}√ó</span></div>
      <div class="tote-loc"><span>üìç ${t.shelf || 'No loc'}</span><button style="color:var(--red); border:none; background:none; cursor:pointer" onclick="deleteTote('${t.id}')">Delete</button></div>
      <div class="items-wrap">${tItems.map(i => `<div class="item-chip" onclick="openDetail('${i.id}')">${i.name}</div>`).join('')}</div>
    </div>`;
  }).join('');

  // Rooms & Stats
  document.getElementById('roomsGrid').innerHTML = rooms.map(r => `<div class="stat-card" style="text-align:left"><b>${r.name}</b> (${r.code})</div>`).join('');
  document.getElementById('sRooms').textContent = rooms.length;
  document.getElementById('sTotes').textContent = totes.length;
  document.getElementById('sItems').textContent = items.length;
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ
function openDetail(id) {
  activeItemId = id;
  const item = items.find(i => i.id == id);
  document.getElementById('detName').value = item.name;
  document.getElementById('detMake').value = item.make || '';
  document.getElementById('detModel').value = item.model || '';
  document.getElementById('detYear').value = item.year || '';
  document.getElementById('detValue').value = item.value || '';
  document.getElementById('detImg').value = item.image_url || '';
  document.getElementById('detailOverlay').classList.add('open');
}

async function saveItem() {
  const updates = { 
    name: document.getElementById('detName').value, 
    make: document.getElementById('detMake').value,
    model: document.getElementById('detModel').value,
    year: document.getElementById('detYear').value,
    value: document.getElementById('detValue').value,
    image_url: document.getElementById('detImg').value
  };
  await sb('PATCH', `items?id=eq.${activeItemId}`, updates);
  Object.assign(items.find(i => i.id == activeItemId), updates);
  closeSheet('detailOverlay');
  renderAll();
}

function openMove(id) {
  activeItemId = id;
  document.getElementById('moveDest').innerHTML = totes.map(t => `<option value="${t.id}">${t.id} - ${t.name}</option>`).join('');
  document.getElementById('moveOverlay').classList.add('open');
}

async function confirmMove() {
  const dest = document.getElementById('moveDest').value;
  await sb('PATCH', `items?id=eq.${activeItemId}`, { tote_id: dest });
  items.find(i => i.id == activeItemId).tote_id = dest;
  closeSheet('moveOverlay');
  renderAll();
}

function closeSheet(id) { document.getElementById(id).classList.remove('open'); }
function openRoomSheet() { document.getElementById('roomOverlay').classList.add('open'); }
function openToteSheet() { 
  document.getElementById('toteRoomSel').innerHTML = rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
  document.getElementById('toteOverlay').classList.add('open'); 
}

async function submitRoom() {
  const name = document.getElementById('roomNameInput').value;
  const code = document.getElementById('roomCodeInput').value.toUpperCase();
  const [r] = await sb('POST', 'rooms', { name, code });
  rooms.push(r); closeSheet('roomOverlay'); renderAll();
}

async function submitTote() {
  const roomId = document.getElementById('toteRoomSel').value;
  const name = document.getElementById('toteNameInput').value;
  const shelf = document.getElementById('toteShelfInput').value;
  const room = rooms.find(r => r.id == roomId);
  const toteId = `${room.code}-${String(totes.filter(t => t.id.startsWith(room.code)).length + 1).padStart(2, '0')}`;
  const [t] = await sb('POST', 'totes', { id: toteId, room_id: roomId, name, shelf });
  totes.push(t); closeSheet('toteOverlay'); renderAll();
}

loadAll();
</script>
</body>
</html>
