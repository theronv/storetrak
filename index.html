<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f0f">
<title>STORETRAK</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow:wght@400;500;600;700&family=Barlow+Condensed:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f0f0f; --surface: #181818; --surface2: #222; --surface3: #2a2a2a;
  --border: #2e2e2e; --border-bright: #484848; --accent: #f0a500;
  --accent-dim: rgba(240,165,0,0.13); --accent-border: rgba(240,165,0,0.32);
  --text: #ece8e0; --text-muted: #787878; --text-dim: #444;
  --green: #4caf78; --red: #c95c5c; --tab-h: 64px; --header-h: 54px;
  --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-top: env(safe-area-inset-top, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Barlow', sans-serif; -webkit-font-smoothing: antialiased; }

/* ‚îÄ‚îÄ UI COMPONENTS ‚îÄ‚îÄ */
.app-header { position: fixed; top: 0; left: 0; right: 0; height: calc(var(--header-h) + var(--safe-top)); padding-top: var(--safe-top); background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding-left: 16px; padding-right: 16px; gap: 12px; z-index: 50; }
.logo { font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700; color: var(--accent); letter-spacing: 3px; }
.header-search { flex: 1; position: relative; }
.header-search input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px 9px 34px; border-radius: 8px; outline: none; }

.app-body { position: fixed; top: calc(var(--header-h) + var(--safe-top)); left: 0; right: 0; bottom: calc(var(--tab-h) + var(--safe-bottom)); overflow-y: auto; -webkit-overflow-scrolling: touch; }

.tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--tab-h) + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: var(--surface); border-top: 1px solid var(--border); display: flex; z-index: 50; }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; cursor: pointer; padding: 6px 4px 4px; }
.tab.active { color: var(--accent); }
.tab-icon { font-size: 20px; color: var(--text-dim); }
.tab.active .tab-icon { color: var(--accent); }
.tab-label { font-family: 'Space Mono', monospace; font-size: 9px; text-transform: uppercase; color: var(--text-dim); }
.tab.active .tab-label { color: var(--accent); }

.page { display: none; padding: 14px; }
.page.active { display: block; }

/* ‚îÄ‚îÄ ITEM CHIPS ‚îÄ‚îÄ */
.items-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
.item-chip { display: inline-flex; align-items: center; gap: 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; font-size: 14px; cursor: pointer; }
.item-chip:active { background: var(--surface3); }
.chip-dot { width: 8px; height: 8px; border-radius: 50%; }
.chip-action { background: none; border: none; color: var(--text-dim); font-size: 16px; padding: 0 4px; cursor: pointer; }
.chip-action:hover { color: var(--accent); }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.add-item-row { display: flex; gap: 6px; }
.item-text-input, .cat-sel { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; font-family: 'Barlow'; }
.btn-add-item { background: var(--accent); color: #000; border: none; padding: 0 16px; border-radius: 6px; font-weight: 700; font-family: 'Barlow Condensed'; cursor: pointer; }

/* ‚îÄ‚îÄ MODALS / SHEETS ‚îÄ‚îÄ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; }
.overlay.open { display: flex; }
.sheet { background: var(--surface); border-top: 1px solid var(--border-bright); border-radius: 16px 16px 0 0; padding: 10px 20px 20px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.25s ease-out; }
.sheet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.field { margin-bottom: 12px; }
.field.full { grid-column: span 2; }
.field label { display: block; font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
.field input, .field select, .field textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; font-size: 15px; font-family: 'Barlow'; outline: none; }
.item-img-preview { width: 100%; height: 160px; background: var(--surface2); border-radius: 8px; margin-bottom: 12px; object-fit: cover; display: none; }
.item-img-preview.has-img { display: block; }

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

@media (min-width: 640px) {
  .app-body, .tab-bar { max-width: 600px; margin: 0 auto; left: 0; right: 0; }
  .overlay { align-items: center; justify-content: center; }
  .sheet { max-width: 450px; border-radius: 16px; margin-bottom: 0; }
}
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">STRTRAK</div>
  <div class="header-search">
    <input id="searchInput" placeholder="Search inventory..." autocomplete="off">
  </div>
  <div id="statusDot" class="status-dot"></div>
</header>

<div class="app-body">
  <div class="page active" id="pageInbox">
    <h2 style="font-family:'Barlow Condensed'; letter-spacing:1px; margin-bottom:10px;">INBOX</h2>
    <div style="background:var(--surface); padding:12px; border-radius:10px; border:1px solid var(--accent-border); margin-bottom:16px;">
      <div class="add-item-row">
        <input class="item-text-input" id="inboxInput" style="flex:1" placeholder="Quick scan item..." onkeydown="if(event.key==='Enter') addInboxItem()">
        <button class="btn-add-item" onclick="addInboxItem()">ADD</button>
      </div>
    </div>
    <div id="inboxList" class="items-wrap"></div>
  </div>

  <div class="page" id="pageTotes">
    <div id="totePageContent"></div>
  </div>
  
  <div class="page" id="pageRooms">
    <div class="rooms-grid" id="roomsGrid"></div>
  </div>
</div>

<nav class="tab-bar">
  <div class="tab active" id="tabInbox" onclick="switchTab('inbox')"><span class="tab-icon">üì•</span><span class="tab-label">Inbox</span></div>
  <div class="tab" id="tabTotes" onclick="switchTab('totes')"><span class="tab-icon">üì¶</span><span class="tab-label">Totes</span></div>
  <div class="tab" id="tabRooms" onclick="switchTab('rooms')"><span class="tab-icon">üè†</span><span class="tab-label">Rooms</span></div>
</nav>

<div class="overlay" id="detailOverlay">
  <div class="sheet">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 id="detailTitleHeader" style="font-family:'Barlow Condensed'; color:var(--accent); letter-spacing:1px;">ITEM DETAILS</h3>
      <button onclick="closeDetail()" style="background:none; border:none; color:var(--text-muted); font-size:24px;">√ó</button>
    </div>
    
    <img id="detailImg" class="item-img-preview" src="">

    <div class="sheet-grid">
      <div class="field full"><label>Item Name</label><input id="detName"></div>
      <div class="field"><label>Make</label><input id="detMake" placeholder="e.g. Sony"></div>
      <div class="field"><label>Model</label><input id="detModel" placeholder="e.g. WH-1000XM4"></div>
      <div class="field"><label>Year</label><input id="detYear" placeholder="2023"></div>
      <div class="field"><label>Value ($)</label><input id="detValue" type="number" placeholder="0.00"></div>
      <div class="field full"><label>Image URL</label><input id="detImgUrl" placeholder="https://..."></div>
      <div class="field full"><label>Location Context</label><input id="detLoc" readonly style="opacity:0.6"></div>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="btn-add-item" style="flex:2; background:var(--green); height:44px;" onclick="saveItem()">SAVE CHANGES</button>
      <button class="btn-add-item" style="flex:1; background:var(--red); height:44px;" onclick="deleteCurrentItem()">DELETE</button>
    </div>
  </div>
</div>

<div class="overlay" id="moveOverlay">
  <div class="sheet" style="max-width:320px">
    <h3 style="font-family:'Barlow Condensed'; margin-bottom:12px;">ASSIGN TO TOTE</h3>
    <div class="field"><label>Select Destination</label><select id="moveDestSel"></select></div>
    <div style="display:flex; gap:8px;">
      <button class="btn-add-item" style="flex:1; height:44px; background:var(--surface2); color:var(--text)" onclick="closeMove()">CANCEL</button>
      <button class="btn-add-item" style="flex:1; height:44px;" onclick="confirmMove()">MOVE</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://kwhawubarlocjluujurq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_dByd8AVDaZEWIoFkpAYXvw_-6HDtTfi';

const CATEGORIES = { tools: {color: '#e05c00'}, electronics: {color: '#4a9eff'}, other: {color: '#555'} };

let rooms = [], totes = [], items = [], activeItem = null, movingItemId = null;

async function sb(method, path, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    method, headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
    body: body ? JSON.stringify(body) : undefined
  });
  return res.json();
}

async function load() {
  [rooms, totes, items] = await Promise.all([sb('GET', 'rooms'), sb('GET', 'totes'), sb('GET', 'items')]);
  renderAll();
}

function renderAll() {
  const inboxList = document.getElementById('inboxList');
  const inboxItems = items.filter(i => !i.tote_id);
  
  inboxList.innerHTML = inboxItems.map(i => `
    <div class="item-chip" onclick="openDetail('${i.id}')">
      <span class="chip-dot" style="background:${(CATEGORIES[i.category]||CATEGORIES.other).color}"></span>
      ${i.name}
      <button class="chip-action" onclick="event.stopPropagation(); openMove('${i.id}')">üì¶</button>
    </div>
  `).join('');
  
  // Basic Totes Rendering for navigation
  const toteContent = document.getElementById('totePageContent');
  toteContent.innerHTML = totes.map(t => `
    <div style="background:var(--surface); margin-bottom:10px; padding:12px; border-radius:10px;">
      <div style="font-weight:700; color:var(--accent)">${t.id} - ${t.name}</div>
      <div class="items-wrap" style="margin-top:10px;">
        ${items.filter(item => item.tote_id === t.id).map(item => `
          <div class="item-chip" onclick="openDetail('${item.id}')">${item.name}</div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ ITEM LOGIC ‚îÄ‚îÄ
async function addInboxItem() {
  const input = document.getElementById('inboxInput');
  if (!input.value.trim()) return;
  const [newItem] = await sb('POST', 'items', { name: input.value.trim(), category: 'other' });
  items.push(newItem);
  input.value = '';
  renderAll();
}

function openDetail(id) {
  activeItem = items.find(i => i.id == id);
  document.getElementById('detName').value = activeItem.name || '';
  document.getElementById('detMake').value = activeItem.make || '';
  document.getElementById('detModel').value = activeItem.model || '';
  document.getElementById('detYear').value = activeItem.year || '';
  document.getElementById('detValue').value = activeItem.value || '';
  document.getElementById('detImgUrl').value = activeItem.image_url || '';
  document.getElementById('detLoc').value = activeItem.tote_id ? `Tote: ${activeItem.tote_id}` : 'Location: INBOX';
  
  const img = document.getElementById('detailImg');
  if (activeItem.image_url) { img.src = activeItem.image_url; img.classList.add('has-img'); }
  else { img.classList.remove('has-img'); }

  document.getElementById('detailOverlay').classList.add('open');
}

async function saveItem() {
  const updates = {
    name: document.getElementById('detName').value,
    make: document.getElementById('detMake').value,
    model: document.getElementById('detModel').value,
    year: document.getElementById('detYear').value,
    value: document.getElementById('detValue').value,
    image_url: document.getElementById('detImgUrl').value
  };
  await sb('PATCH', `items?id=eq.${activeItem.id}`, updates);
  Object.assign(activeItem, updates);
  closeDetail();
  renderAll();
}

async function deleteCurrentItem() {
  if (!confirm('Delete this item permanently?')) return;
  await sb('DELETE', `items?id=eq.${activeItem.id}`);
  items = items.filter(i => i.id !== activeItem.id);
  closeDetail();
  renderAll();
}

// ‚îÄ‚îÄ MOVE LOGIC ‚îÄ‚îÄ
function openMove(id) {
  movingItemId = id;
  const sel = document.getElementById('moveDestSel');
  sel.innerHTML = totes.map(t => `<option value="${t.id}">${t.id} - ${t.name}</option>`).join('');
  document.getElementById('moveOverlay').classList.add('open');
}

async function confirmMove() {
  const dest = document.getElementById('moveDestSel').value;
  await sb('PATCH', `items?id=eq.${movingItemId}`, { tote_id: dest });
  const item = items.find(i => i.id == movingItemId);
  item.tote_id = dest;
  closeMove();
  renderAll();
}

function closeDetail() { document.getElementById('detailOverlay').classList.remove('open'); }
function closeMove() { document.getElementById('moveOverlay').classList.remove('open'); }

function switchTab(tab) {
  document.querySelectorAll('.tab, .page').forEach(el => el.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('page' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

load();
</script>
</body>
</html>
