<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STORETRAK ‚Äî Home Storage Organizer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #222;
    --border: #333;
    --border-bright: #555;
    --accent: #f0a500;
    --accent2: #e05c00;
    --text: #e8e8e8;
    --text-muted: #888;
    --text-dim: #555;
    --green: #4caf78;
    --red: #e05c5c;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    font-size: 15px;
  }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 3px;
  }
  .logo span { color: var(--text-muted); font-weight: 400; font-size: 11px; letter-spacing: 1px; margin-left: 12px; }
  .header-stats {
    display: flex;
    gap: 24px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
  }
  .header-stats b { color: var(--accent); }

  /* LAYOUT */
  .app { display: flex; height: calc(100vh - 56px); }
  .sidebar {
    width: 260px;
    min-width: 260px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .main { flex: 1; overflow-y: auto; padding: 24px; }

  /* SIDEBAR */
  .sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--text-muted);
    text-transform: uppercase;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .btn-icon {
    background: var(--accent);
    color: #000;
    border: none;
    width: 22px;
    height: 22px;
    border-radius: 3px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    line-height: 1;
    transition: background 0.15s;
  }
  .btn-icon:hover { background: var(--accent2); }
  .rooms-list { flex: 1; overflow-y: auto; padding: 8px 0; }
  .room-item {
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.1s;
    border-left: 3px solid transparent;
  }
  .room-item:hover { background: var(--surface2); }
  .room-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .room-name { font-weight: 500; font-size: 14px; }
  .room-code {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--accent);
    background: rgba(240,165,0,0.1);
    padding: 2px 6px;
    border-radius: 3px;
  }
  .room-count {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    margin-left: auto;
    margin-right: 8px;
  }
  .room-delete {
    opacity: 0;
    background: none;
    border: none;
    color: var(--red);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 4px;
    transition: opacity 0.15s;
  }
  .room-item:hover .room-delete { opacity: 1; }
  .sidebar-all {
    padding: 10px 16px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 3px solid transparent;
  }
  .sidebar-all.active { border-left-color: var(--accent); background: var(--surface2); }
  .sidebar-all:hover { background: var(--surface2); }

  /* SEARCH BAR */
  .search-wrap {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }
  .search-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border-bright);
    color: var(--text);
    padding: 8px 12px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text-dim); }

  /* MAIN AREA */
  .section-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text);
    margin-bottom: 4px;
  }
  .section-sub {
    color: var(--text-muted);
    font-size: 13px;
    margin-bottom: 20px;
  }

  /* TOTE GRID */
  .tote-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }
  .tote-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    transition: border-color 0.15s, transform 0.15s;
  }
  .tote-card:hover { border-color: var(--border-bright); transform: translateY(-1px); }
  .tote-card-header {
    padding: 12px 14px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .tote-id {
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--accent);
    background: rgba(240,165,0,0.12);
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid rgba(240,165,0,0.3);
  }
  .tote-name { font-weight: 600; font-size: 14px; flex: 1; }
  .tote-item-count {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
  }
  .tote-actions { display: flex; gap: 4px; }
  .btn-sm {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 3px 8px;
    font-size: 11px;
    border-radius: 3px;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
    transition: all 0.1s;
  }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm.danger:hover { border-color: var(--red); color: var(--red); }
  .tote-shelf {
    font-size: 11px;
    color: var(--text-muted);
    padding: 0 14px 6px;
    margin-top: 6px;
    font-family: 'Space Mono', monospace;
  }
  .tote-items { padding: 8px 14px 12px; }
  .item-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 3px 8px;
    font-size: 12px;
    margin: 2px;
    transition: border-color 0.1s;
  }
  .item-tag .cat-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .item-tag .remove-item {
    background: none; border: none; color: var(--text-dim);
    cursor: pointer; font-size: 13px; padding: 0; line-height: 1;
    opacity: 0; transition: opacity 0.1s;
  }
  .item-tag:hover .remove-item { opacity: 1; }
  .item-tag:hover { border-color: var(--border-bright); }
  .add-item-form {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }
  .item-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 5px 8px;
    font-size: 12px;
    border-radius: 3px;
    font-family: 'Barlow', sans-serif;
    outline: none;
  }
  .item-input:focus { border-color: var(--accent); }
  .cat-select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 5px 6px;
    font-size: 11px;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
  }
  .btn-add-item {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 5px 10px;
    font-size: 12px;
    font-weight: 700;
    border-radius: 3px;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
    transition: background 0.1s;
  }
  .btn-add-item:hover { background: var(--accent2); }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
  .empty-state h3 { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }

  /* SEARCH RESULTS */
  .search-result-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 14px;
    animation: fadeIn 0.2s ease;
  }
  .sr-item-name { font-weight: 600; flex: 1; }
  .sr-location {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    background: rgba(240,165,0,0.1);
    padding: 3px 8px;
    border-radius: 3px;
  }
  .sr-tote { font-size: 13px; color: var(--text-muted); }

  /* ADD TOTE MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-top: 2px solid var(--accent);
    border-radius: 6px;
    padding: 24px;
    width: 420px;
    max-width: 95vw;
    animation: slideUp 0.2s ease;
  }
  .modal h2 {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 16px;
    color: var(--accent);
  }
  .form-row { margin-bottom: 12px; }
  .form-label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 5px;
    font-family: 'Space Mono', monospace;
  }
  .form-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border-bright);
    color: var(--text);
    padding: 9px 12px;
    font-size: 14px;
    border-radius: 4px;
    font-family: 'Barlow', sans-serif;
    outline: none;
    transition: border-color 0.15s;
  }
  .form-input:focus { border-color: var(--accent); }
  .form-row-hint { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .tote-id-preview {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    background: rgba(240,165,0,0.1);
    padding: 6px 10px;
    border-radius: 4px;
    margin-bottom: 12px;
    border: 1px solid rgba(240,165,0,0.25);
  }
  .modal-actions { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }
  .btn-primary {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 9px 20px;
    font-weight: 700;
    font-size: 13px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
    transition: background 0.1s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-secondary {
    background: none;
    color: var(--text-muted);
    border: 1px solid var(--border);
    padding: 9px 16px;
    font-size: 13px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
    transition: border-color 0.1s;
  }
  .btn-secondary:hover { border-color: var(--border-bright); color: var(--text); }

  /* ADD ROOM MODAL */
  .add-room-modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-top: 2px solid var(--accent);
    border-radius: 6px;
    padding: 20px;
    width: 360px;
    max-width: 95vw;
    animation: slideUp 0.2s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .highlight { background: rgba(240,165,0,0.3); border-radius: 2px; }

  /* CATEGORY COLORS */
  .cat-tools { background: #e05c00; }
  .cat-electronics { background: #4a9eff; }
  .cat-cables { background: #7c4aff; }
  .cat-hardware { background: #888; }
  .cat-craft { background: #e04aaa; }
  .cat-seasonal { background: #4caf78; }
  .cat-other { background: #555; }

  /* FAB */
  .fab {
    position: fixed;
    bottom: 28px;
    right: 28px;
    background: var(--accent);
    color: #000;
    border: none;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    font-size: 26px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(240,165,0,0.4);
    z-index: 50;
    transition: transform 0.2s, background 0.1s;
    font-weight: 300;
    line-height: 1;
  }
  .fab:hover { transform: scale(1.08); background: var(--accent2); }

  .cat-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
  }
  .cat-pill {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-muted);
  }
  .cat-pill .dot { width: 8px; height: 8px; border-radius: 50%; }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="logo">STORETRAK <span>HOME STORAGE SYSTEM</span></div>
  <div class="header-stats">
    <span><b id="stat-rooms">0</b> ROOMS</span>
    <span><b id="stat-totes">0</b> TOTES</span>
    <span><b id="stat-items">0</b> ITEMS</span>
  </div>
</header>

<div class="app">
  <div class="sidebar">
    <div class="search-wrap">
      <input class="search-input" id="searchInput" placeholder="Search items..." autocomplete="off">
    </div>
    <div class="sidebar-all active" id="navAll" onclick="selectRoom('all')">
      <span>All Rooms</span>
      <span id="allCount" style="font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim)"></span>
    </div>
    <div class="sidebar-header">
      Rooms
      <button class="btn-icon" onclick="openAddRoomModal()" title="Add Room">+</button>
    </div>
    <div class="rooms-list" id="roomsList"></div>
    <div class="cat-legend" id="catLegend"></div>
  </div>

  <div class="main" id="mainArea">
    <div class="empty-state">
      <div class="empty-icon">üì¶</div>
      <h3>No totes yet</h3>
      <p>Add a room, then hit <b>+</b> to create your first tote.</p>
    </div>
  </div>
</div>

<button class="fab" onclick="openAddToteModal()" title="Add Tote">+</button>

<!-- ADD TOTE MODAL -->
<div class="modal-overlay" id="toteModal">
  <div class="modal">
    <h2>Add New Tote</h2>
    <div class="form-row">
      <label class="form-label">Room</label>
      <select class="form-input" id="toteRoom" onchange="updateToteIdPreview()"></select>
    </div>
    <div class="form-row">
      <label class="form-label">Tote Name (optional)</label>
      <input class="form-input" id="toteName" placeholder="e.g. Power Tools, Christmas Decor" autocomplete="off">
    </div>
    <div class="form-row">
      <label class="form-label">Shelf / Location</label>
      <input class="form-input" id="toteShelf" placeholder="e.g. Shelf 2, Top shelf, Under stairs" autocomplete="off">
    </div>
    <div class="tote-id-preview" id="toteIdPreview">ID: ‚Äî</div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeToteModal()">Cancel</button>
      <button class="btn-primary" onclick="addTote()">Create Tote</button>
    </div>
  </div>
</div>

<!-- ADD ROOM MODAL -->
<div class="modal-overlay" id="roomModal">
  <div class="add-room-modal">
    <h2 style="font-family:'Barlow Condensed',sans-serif;font-size:18px;letter-spacing:2px;text-transform:uppercase;margin-bottom:16px;color:var(--accent);">Add Room</h2>
    <div class="form-row">
      <label class="form-label">Room Name</label>
      <input class="form-input" id="roomName" placeholder="e.g. Garage, Basement, Attic" autocomplete="off">
    </div>
    <div class="form-row">
      <label class="form-label">Short Code (3-4 letters)</label>
      <input class="form-input" id="roomCode" placeholder="e.g. GAR, BSM, ATT" maxlength="4" autocomplete="off"
        oninput="this.value=this.value.toUpperCase()">
      <div class="form-row-hint">Used to generate tote IDs like GAR-01</div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeRoomModal()">Cancel</button>
      <button class="btn-primary" onclick="addRoom()">Add Room</button>
    </div>
  </div>
</div>

<script>
const CATEGORIES = {
  tools:       { label: 'Tools',       color: '#e05c00' },
  electronics: { label: 'Electronics', color: '#4a9eff' },
  cables:      { label: 'Cables',      color: '#7c4aff' },
  hardware:    { label: 'Hardware',    color: '#888' },
  craft:       { label: 'Craft',       color: '#e04aaa' },
  seasonal:    { label: 'Seasonal',    color: '#4caf78' },
  other:       { label: 'Other',       color: '#555' },
};

let state = {
  rooms: [],
  totes: [],
  selectedRoom: 'all',
  searchQuery: '',
};

// --- STORAGE ---
async function saveState() {
  try {
    await window.storage.set('storetrak-state', JSON.stringify(state));
  } catch(e) { /* ignore */ }
}
async function loadState() {
  try {
    const r = await window.storage.get('storetrak-state');
    if (r && r.value) {
      const s = JSON.parse(r.value);
      state.rooms = s.rooms || [];
      state.totes = s.totes || [];
    }
  } catch(e) { /* no saved data */ }
}

// --- ROOMS ---
function openAddRoomModal() {
  document.getElementById('roomName').value = '';
  document.getElementById('roomCode').value = '';
  document.getElementById('roomModal').classList.add('open');
  setTimeout(() => document.getElementById('roomName').focus(), 50);
}
function closeRoomModal() {
  document.getElementById('roomModal').classList.remove('open');
}
function addRoom() {
  const name = document.getElementById('roomName').value.trim();
  const code = document.getElementById('roomCode').value.trim().toUpperCase();
  if (!name || !code) return alert('Please fill in both fields.');
  if (state.rooms.find(r => r.code === code)) return alert('That code is already taken.');
  state.rooms.push({ id: Date.now().toString(), name, code });
  saveState();
  render();
  closeRoomModal();
}
function deleteRoom(id) {
  if (!confirm('Delete this room and all its totes?')) return;
  state.rooms = state.rooms.filter(r => r.id !== id);
  state.totes = state.totes.filter(t => t.roomId !== id);
  if (state.selectedRoom === id) state.selectedRoom = 'all';
  saveState();
  render();
}

// --- TOTES ---
function openAddToteModal() {
  const select = document.getElementById('toteRoom');
  select.innerHTML = state.rooms.map(r =>
    `<option value="${r.id}">${r.name} (${r.code})</option>`
  ).join('');
  if (state.selectedRoom !== 'all') {
    select.value = state.selectedRoom;
  }
  document.getElementById('toteName').value = '';
  document.getElementById('toteShelf').value = '';
  updateToteIdPreview();
  document.getElementById('toteModal').classList.add('open');
  setTimeout(() => document.getElementById('toteName').focus(), 50);
}
function closeToteModal() {
  document.getElementById('toteModal').classList.remove('open');
}
function updateToteIdPreview() {
  const roomId = document.getElementById('toteRoom').value;
  const room = state.rooms.find(r => r.id === roomId);
  if (!room) { document.getElementById('toteIdPreview').textContent = 'ID: ‚Äî'; return; }
  const existing = state.totes.filter(t => t.roomId === roomId).length;
  const num = String(existing + 1).padStart(2, '0');
  document.getElementById('toteIdPreview').textContent = `ID: ${room.code}-${num}`;
}
function addTote() {
  const roomId = document.getElementById('toteRoom').value;
  const room = state.rooms.find(r => r.id === roomId);
  if (!room) return alert('Select a room.');
  const existing = state.totes.filter(t => t.roomId === roomId).length;
  const num = String(existing + 1).padStart(2, '0');
  const toteId = `${room.code}-${num}`;
  const name = document.getElementById('toteName').value.trim() || toteId;
  const shelf = document.getElementById('toteShelf').value.trim();
  state.totes.push({ id: toteId, roomId, name, shelf, items: [] });
  saveState();
  render();
  closeToteModal();
}
function deleteTote(id) {
  if (!confirm(`Delete tote ${id}?`)) return;
  state.totes = state.totes.filter(t => t.id !== id);
  saveState();
  render();
}

// --- ITEMS ---
function addItem(toteId) {
  const input = document.getElementById(`item-input-${toteId}`);
  const catSel = document.getElementById(`cat-sel-${toteId}`);
  const val = input.value.trim();
  if (!val) return;
  const tote = state.totes.find(t => t.id === toteId);
  if (!tote) return;
  tote.items.push({ id: Date.now().toString(), name: val, cat: catSel.value });
  input.value = '';
  saveState();
  render();
  // Re-focus the input
  setTimeout(() => {
    const el = document.getElementById(`item-input-${toteId}`);
    if (el) el.focus();
  }, 30);
}
function removeItem(toteId, itemId) {
  const tote = state.totes.find(t => t.id === toteId);
  if (!tote) return;
  tote.items = tote.items.filter(i => i.id !== itemId);
  saveState();
  render();
}

// --- RENDER ---
function selectRoom(id) {
  state.selectedRoom = id;
  state.searchQuery = '';
  document.getElementById('searchInput').value = '';
  render();
}

function highlight(text, query) {
  if (!query) return escHtml(text);
  const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
  return escHtml(text).replace(re, '<mark class="highlight">$1</mark>');
}
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderCatSelect(toteId) {
  return `<select class="cat-select" id="cat-sel-${toteId}">
    ${Object.entries(CATEGORIES).map(([k,v]) => `<option value="${k}">${v.label}</option>`).join('')}
  </select>`;
}

function render() {
  // Stats
  const totalItems = state.totes.reduce((s,t) => s + t.items.length, 0);
  document.getElementById('stat-rooms').textContent = state.rooms.length;
  document.getElementById('stat-totes').textContent = state.totes.length;
  document.getElementById('stat-items').textContent = totalItems;
  document.getElementById('allCount').textContent = state.totes.length;

  // Sidebar rooms
  const roomsList = document.getElementById('roomsList');
  roomsList.innerHTML = state.rooms.map(r => {
    const count = state.totes.filter(t => t.roomId === r.id).length;
    return `<div class="room-item ${state.selectedRoom === r.id ? 'active' : ''}" onclick="selectRoom('${r.id}')">
      <span class="room-name">${escHtml(r.name)}</span>
      <span class="room-count">${count}</span>
      <span class="room-code">${r.code}</span>
      <button class="room-delete" onclick="event.stopPropagation();deleteRoom('${r.id}')" title="Delete room">√ó</button>
    </div>`;
  }).join('');

  // Nav all active
  document.getElementById('navAll').className = 'sidebar-all' + (state.selectedRoom === 'all' ? ' active' : '');

  // Category legend
  document.getElementById('catLegend').innerHTML = Object.entries(CATEGORIES).map(([k,v]) =>
    `<span class="cat-pill"><span class="dot" style="background:${v.color}"></span>${v.label}</span>`
  ).join('');

  // Main area
  const main = document.getElementById('mainArea');
  const q = state.searchQuery.toLowerCase().trim();

  // SEARCH MODE
  if (q) {
    const results = [];
    state.totes.forEach(tote => {
      tote.items.forEach(item => {
        if (item.name.toLowerCase().includes(q)) {
          const room = state.rooms.find(r => r.id === tote.roomId);
          results.push({ item, tote, room });
        }
      });
    });
    if (!results.length) {
      main.innerHTML = `<div class="section-title">Search Results</div>
        <div class="section-sub">No items match "<b>${escHtml(state.searchQuery)}</b>"</div>
        <div class="empty-state"><div class="empty-icon">üîç</div><h3>Nothing found</h3><p>Try a different search term.</p></div>`;
      return;
    }
    main.innerHTML = `<div class="section-title">Search Results</div>
      <div class="section-sub">${results.length} item${results.length !== 1 ? 's' : ''} matching "<b>${escHtml(state.searchQuery)}</b>"</div>
      ${results.map(({item, tote, room}) => {
        const cat = CATEGORIES[item.cat] || CATEGORIES.other;
        return `<div class="search-result-item">
          <span class="cat-dot" style="width:9px;height:9px;border-radius:50%;background:${cat.color};flex-shrink:0"></span>
          <span class="sr-item-name">${highlight(item.name, state.searchQuery)}</span>
          <span class="sr-tote">${escHtml(tote.name)}</span>
          <span class="sr-location">${tote.id}${tote.shelf ? ' ¬∑ '+escHtml(tote.shelf) : ''}${room ? ' ¬∑ '+escHtml(room.name) : ''}</span>
        </div>`;
      }).join('')}`;
    return;
  }

  // NORMAL VIEW
  const filteredTotes = state.selectedRoom === 'all'
    ? state.totes
    : state.totes.filter(t => t.roomId === state.selectedRoom);

  const room = state.rooms.find(r => r.id === state.selectedRoom);
  const titleText = state.selectedRoom === 'all' ? 'All Totes' : (room ? room.name : 'All Totes');
  const subText = state.selectedRoom === 'all'
    ? `${state.totes.length} tote${state.totes.length !== 1 ? 's' : ''} across ${state.rooms.length} room${state.rooms.length !== 1 ? 's' : ''}`
    : `${filteredTotes.length} tote${filteredTotes.length !== 1 ? 's' : ''}${room ? ' ¬∑ Code: ' + room.code : ''}`;

  if (!state.rooms.length) {
    main.innerHTML = `<div class="empty-state"><div class="empty-icon">üè†</div><h3>Add a Room First</h3><p>Click <b>+</b> in the sidebar to add your first room (e.g. Garage, Basement).</p></div>`;
    return;
  }

  if (!filteredTotes.length) {
    main.innerHTML = `<div class="section-title">${escHtml(titleText)}</div>
      <div class="section-sub">${escHtml(subText)}</div>
      <div class="empty-state"><div class="empty-icon">üì¶</div><h3>No Totes Yet</h3><p>Click the <b>+</b> button to add your first tote.</p></div>`;
    return;
  }

  main.innerHTML = `<div class="section-title">${escHtml(titleText)}</div>
    <div class="section-sub">${escHtml(subText)}</div>
    <div class="tote-grid">
      ${filteredTotes.map(tote => {
        const roomObj = state.rooms.find(r => r.id === tote.roomId);
        return `<div class="tote-card">
          <div class="tote-card-header">
            <span class="tote-id">${escHtml(tote.id)}</span>
            <span class="tote-name">${escHtml(tote.name)}</span>
            <span class="tote-item-count">${tote.items.length} item${tote.items.length !== 1 ? 's' : ''}</span>
            <div class="tote-actions">
              <button class="btn-sm danger" onclick="deleteTote('${tote.id}')">DEL</button>
            </div>
          </div>
          ${tote.shelf ? `<div class="tote-shelf">üìç ${escHtml(tote.shelf)}${state.selectedRoom === 'all' && roomObj ? ' ¬∑ ' + escHtml(roomObj.name) : ''}</div>` : (state.selectedRoom === 'all' && roomObj ? `<div class="tote-shelf">üìç ${escHtml(roomObj.name)}</div>` : '')}
          <div class="tote-items">
            ${tote.items.map(item => {
              const cat = CATEGORIES[item.cat] || CATEGORIES.other;
              return `<span class="item-tag">
                <span class="cat-dot" style="background:${cat.color}"></span>
                ${escHtml(item.name)}
                <button class="remove-item" onclick="removeItem('${tote.id}','${item.id}')" title="Remove">√ó</button>
              </span>`;
            }).join('')}
            <div class="add-item-form">
              <input class="item-input" id="item-input-${tote.id}" placeholder="Add item..."
                onkeydown="if(event.key==='Enter') addItem('${tote.id}')">
              ${renderCatSelect(tote.id)}
              <button class="btn-add-item" onclick="addItem('${tote.id}')">ADD</button>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

// Search
document.getElementById('searchInput').addEventListener('input', function() {
  state.searchQuery = this.value;
  render();
});

// Close modals on overlay click
document.getElementById('toteModal').addEventListener('click', function(e) {
  if (e.target === this) closeToteModal();
});
document.getElementById('roomModal').addEventListener('click', function(e) {
  if (e.target === this) closeRoomModal();
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeToteModal(); closeRoomModal(); }
});

// Init
(async () => {
  await loadState();
  render();
})();
</script>
</body>
</html>
