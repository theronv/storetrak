<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STORETRAK</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #171717;
    --surface2: #1f1f1f;
    --surface3: #252525;
    --border: #2a2a2a;
    --border-bright: #444;
    --accent: #f0a500;
    --accent-dim: rgba(240,165,0,0.12);
    --accent-border: rgba(240,165,0,0.3);
    --accent2: #d48f00;
    --text: #e8e4dc;
    --text-muted: #777;
    --text-dim: #444;
    --green: #4caf78;
    --red: #c95c5c;
    --blue: #4a9eff;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    font-size: 15px;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 52px;
    position: sticky;
    top: 0;
    z-index: 100;
    gap: 16px;
  }
  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 15px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 4px;
    white-space: nowrap;
  }
  .logo-sub { color: var(--text-dim); font-size: 9px; letter-spacing: 2px; display: block; margin-top: -3px; }
  .header-search {
    flex: 1;
    max-width: 420px;
    position: relative;
  }
  .header-search input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 7px 12px 7px 34px;
    font-family: 'Barlow', sans-serif;
    font-size: 13px;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.15s;
  }
  .header-search input:focus { border-color: var(--accent); }
  .header-search input::placeholder { color: var(--text-dim); }
  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    font-size: 14px;
    pointer-events: none;
  }
  .header-stats {
    display: flex;
    gap: 20px;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    white-space: nowrap;
  }
  .header-stats b { color: var(--accent); font-size: 13px; display: block; }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    display: inline-block;
    margin-right: 6px;
    animation: pulse 2s infinite;
  }
  .status-dot.loading { background: var(--accent); }
  .status-dot.error { background: var(--red); animation: none; }
  @keyframes pulse {
    0%,100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .status-label { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text-muted); }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .app { display: flex; height: calc(100vh - 52px); }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    width: 240px;
    min-width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sidebar-section-head {
    padding: 10px 14px 8px;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--text-dim);
    text-transform: uppercase;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }
  .btn-add-small {
    background: var(--accent);
    color: #000;
    border: none;
    width: 18px; height: 18px;
    border-radius: 3px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    line-height: 1;
    transition: background 0.1s;
    flex-shrink: 0;
  }
  .btn-add-small:hover { background: var(--accent2); }

  .nav-item {
    padding: 9px 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border-left: 2px solid transparent;
    transition: background 0.1s;
    font-size: 13px;
  }
  .nav-item:hover { background: var(--surface2); }
  .nav-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .nav-item .nav-label { flex: 1; font-weight: 500; }
  .nav-item .nav-code {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--accent);
    background: var(--accent-dim);
    padding: 2px 5px;
    border-radius: 2px;
  }
  .nav-item .nav-count {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--text-dim);
  }
  .nav-item .nav-del {
    opacity: 0;
    background: none;
    border: none;
    color: var(--red);
    cursor: pointer;
    font-size: 15px;
    padding: 0 2px;
    line-height: 1;
    transition: opacity 0.1s;
  }
  .nav-item:hover .nav-del { opacity: 1; }

  .rooms-scroll { flex: 1; overflow-y: auto; }

  .cat-legend {
    padding: 10px 14px;
    border-top: 1px solid var(--border);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .cat-pill { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-muted); }
  .cat-dot-sm { width: 6px; height: 6px; border-radius: 50%; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main { flex: 1; overflow-y: auto; padding: 20px 24px; }

  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 12px;
  }
  .page-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    line-height: 1;
  }
  .page-sub { color: var(--text-muted); font-size: 12px; margin-top: 4px; font-family: 'Space Mono', monospace; }
  .btn-primary {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 9px 18px;
    font-weight: 700;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    letter-spacing: 1px;
    text-transform: uppercase;
    white-space: nowrap;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary:hover { background: var(--accent2); }

  /* ‚îÄ‚îÄ TOTE GRID ‚îÄ‚îÄ */
  .tote-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
    gap: 14px;
  }
  .tote-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .tote-card:hover { border-color: var(--border-bright); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .tote-card-head {
    padding: 10px 12px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tote-badge {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    background: var(--accent-dim);
    border: 1px solid var(--accent-border);
    padding: 2px 7px;
    border-radius: 3px;
    white-space: nowrap;
  }
  .tote-title { font-weight: 600; font-size: 13px; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tote-meta { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--text-dim); white-space: nowrap; }
  .tote-card-sub {
    padding: 5px 12px;
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'Space Mono', monospace;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .tote-del-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 12px;
    padding: 0;
    font-family: 'Barlow', sans-serif;
    transition: color 0.1s;
  }
  .tote-del-btn:hover { color: var(--red); }

  .tote-body { padding: 10px 12px 12px; }
  .items-wrap { min-height: 24px; }
  .item-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 3px 7px;
    font-size: 12px;
    margin: 2px;
    transition: border-color 0.1s;
    cursor: default;
  }
  .item-chip:hover { border-color: var(--border-bright); }
  .item-chip .chip-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .item-chip .chip-del {
    background: none; border: none; color: var(--text-dim);
    cursor: pointer; font-size: 14px; padding: 0; line-height: 1;
    opacity: 0; transition: opacity 0.1s; margin-left: 2px;
  }
  .item-chip:hover .chip-del { opacity: 1; }

  .add-item-row {
    display: flex;
    gap: 5px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }
  .item-text-input {
    flex: 1;
    min-width: 0;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 5px 8px;
    font-size: 12px;
    border-radius: 3px;
    font-family: 'Barlow', sans-serif;
    outline: none;
    transition: border-color 0.15s;
  }
  .item-text-input:focus { border-color: var(--accent); }
  .item-text-input::placeholder { color: var(--text-dim); }
  .cat-sel {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 5px 4px;
    font-size: 11px;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    max-width: 90px;
  }
  .btn-add-item {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 5px 10px;
    font-size: 11px;
    font-weight: 700;
    border-radius: 3px;
    cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    letter-spacing: 1px;
    transition: background 0.1s;
    white-space: nowrap;
  }
  .btn-add-item:hover { background: var(--accent2); }

  /* ‚îÄ‚îÄ SEARCH RESULTS ‚îÄ‚îÄ */
  .search-results { display: flex; flex-direction: column; gap: 6px; }
  .sr-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 11px 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: fadeIn 0.15s ease;
    transition: border-color 0.1s;
  }
  .sr-card:hover { border-color: var(--border-bright); }
  .sr-item-name { font-weight: 600; font-size: 14px; flex: 1; }
  .sr-tote-name { font-size: 12px; color: var(--text-muted); }
  .sr-loc {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--accent);
    background: var(--accent-dim);
    border: 1px solid var(--accent-border);
    padding: 3px 8px;
    border-radius: 3px;
    white-space: nowrap;
  }
  .sr-shelf { font-size: 11px; color: var(--text-dim); font-family: 'Space Mono', monospace; }

  /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-top: 2px solid var(--accent);
    border-radius: 6px;
    padding: 22px;
    width: 400px;
    max-width: 95vw;
    animation: slideUp 0.18s ease;
  }
  .modal-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 16px;
  }
  .field { margin-bottom: 12px; }
  .field label {
    display: block;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 5px;
  }
  .field input, .field select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border-bright);
    color: var(--text);
    padding: 8px 11px;
    font-size: 13px;
    border-radius: 4px;
    font-family: 'Barlow', sans-serif;
    outline: none;
    transition: border-color 0.15s;
  }
  .field input:focus, .field select:focus { border-color: var(--accent); }
  .field-hint { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .id-preview {
    background: var(--accent-dim);
    border: 1px solid var(--accent-border);
    border-radius: 4px;
    padding: 7px 10px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    margin-bottom: 14px;
  }
  .modal-btns { display: flex; justify-content: flex-end; gap: 8px; margin-top: 18px; }
  .btn-cancel {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 8px 14px;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
    transition: border-color 0.1s;
  }
  .btn-cancel:hover { border-color: var(--border-bright); color: var(--text); }
  .btn-confirm {
    background: var(--accent);
    color: #000;
    border: none;
    padding: 8px 18px;
    font-weight: 700;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Barlow Condensed', sans-serif;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: background 0.1s;
  }
  .btn-confirm:hover { background: var(--accent2); }
  .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }

  /* ‚îÄ‚îÄ EMPTY / LOADING ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-icon { font-size: 44px; margin-bottom: 12px; opacity: 0.35; }
  .empty-state h3 {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
    color: var(--text-muted);
  }
  .empty-state p { font-size: 13px; color: var(--text-dim); }

  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface3);
    border: 1px solid var(--border-bright);
    color: var(--text);
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    z-index: 300;
    transition: transform 0.25s ease;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error { border-color: var(--red); color: var(--red); }

  mark { background: rgba(240,165,0,0.3); color: inherit; border-radius: 2px; padding: 0 1px; }

  @keyframes slideUp {
    from { transform: translateY(16px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  @media (max-width: 640px) {
    .sidebar { width: 180px; min-width: 180px; }
    .header-stats { display: none; }
    .tote-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">STORETRAK<span class="logo-sub">HOME INVENTORY</span></div>
  <div class="header-search">
    <span class="search-icon">‚åï</span>
    <input id="searchInput" placeholder="Search any item..." autocomplete="off">
  </div>
  <div class="header-stats">
    <div><b id="statRooms">‚Äî</b>ROOMS</div>
    <div><b id="statTotes">‚Äî</b>TOTES</div>
    <div><b id="statItems">‚Äî</b>ITEMS</div>
    <div>
      <span id="statusDot" class="status-dot loading"></span>
      <span id="statusLabel" class="status-label">CONNECTING</span>
    </div>
  </div>
</header>

<div class="app">
  <div class="sidebar">
    <div class="nav-item active" id="navAll" onclick="selectRoom('all')" style="border-bottom:1px solid var(--border);font-weight:600;">
      <span class="nav-label">All Rooms</span>
      <span class="nav-count" id="allCount"></span>
    </div>
    <div class="sidebar-section-head">
      Rooms
      <button class="btn-add-small" onclick="openRoomModal()" title="Add Room">+</button>
    </div>
    <div class="rooms-scroll" id="roomsNav"></div>
    <div class="cat-legend" id="catLegend"></div>
  </div>

  <div class="main" id="mainArea">
    <div class="empty-state">
      <div class="empty-icon">‚ü≥</div>
      <h3>Loading</h3>
      <p>Connecting to database...</p>
    </div>
  </div>
</div>

<!-- ADD ROOM MODAL -->
<div class="overlay" id="roomOverlay">
  <div class="modal" style="width:340px;">
    <div class="modal-title">Add Room</div>
    <div class="field">
      <label>Room Name</label>
      <input id="roomNameInput" placeholder="e.g. Garage, Basement, Attic">
    </div>
    <div class="field">
      <label>Short Code (3‚Äì4 letters)</label>
      <input id="roomCodeInput" placeholder="e.g. GAR, BSM, ATT" maxlength="4" oninput="this.value=this.value.toUpperCase()">
      <div class="field-hint">Used to generate tote IDs like GAR-01</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeRoomModal()">Cancel</button>
      <button class="btn-confirm" id="roomSubmitBtn" onclick="submitRoom()">Add Room</button>
    </div>
  </div>
</div>

<!-- ADD TOTE MODAL -->
<div class="overlay" id="toteOverlay">
  <div class="modal">
    <div class="modal-title">Add New Tote</div>
    <div class="field">
      <label>Room</label>
      <select id="toteRoomSel" onchange="updateIdPreview()"></select>
    </div>
    <div class="field">
      <label>Tote Name (optional)</label>
      <input id="toteNameInput" placeholder="e.g. Power Tools, Holiday Decor">
    </div>
    <div class="field">
      <label>Shelf / Location</label>
      <input id="toteShelfInput" placeholder="e.g. Shelf 2, Top shelf, Left wall">
    </div>
    <div class="id-preview" id="idPreview">ID will be assigned automatically</div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeToteModal()">Cancel</button>
      <button class="btn-confirm" id="toteSubmitBtn" onclick="submitTote()">Create Tote</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const SUPABASE_URL = 'https://kwhawubarlocjluujurq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_dByd8AVDaZEWIoFkpAYXvw_-6HDtTfi';

const CATEGORIES = {
  tools:       { label: 'Tools',       color: '#e05c00' },
  electronics: { label: 'Electronics', color: '#4a9eff' },
  cables:      { label: 'Cables',      color: '#7c4aff' },
  hardware:    { label: 'Hardware',    color: '#aaa' },
  craft:       { label: 'Craft',       color: '#e04aaa' },
  seasonal:    { label: 'Seasonal',    color: '#4caf78' },
  clothing:    { label: 'Clothing',    color: '#c89b4a' },
  other:       { label: 'Other',       color: '#555' },
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let rooms = [];
let totes = [];
let items = [];
let selectedRoom = 'all';
let searchQuery = '';

// ‚îÄ‚îÄ SUPABASE API ‚îÄ‚îÄ
async function sb(method, path, body) {
  const opts = {
    method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': method === 'POST' ? 'return=representation' : undefined,
    },
    body: body ? JSON.stringify(body) : undefined,
  };
  // Remove undefined headers
  Object.keys(opts.headers).forEach(k => opts.headers[k] === undefined && delete opts.headers[k]);
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, opts);
  if (!res.ok) {
    const err = await res.text();
    throw new Error(err);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

// ‚îÄ‚îÄ LOAD ALL DATA ‚îÄ‚îÄ
async function loadAll() {
  setStatus('loading', 'LOADING');
  try {
    [rooms, totes, items] = await Promise.all([
      sb('GET', 'rooms?select=*&order=name'),
      sb('GET', 'totes?select=*&order=created_at'),
      sb('GET', 'items?select=*&order=created_at'),
    ]);
    setStatus('ok', 'LIVE');
    render();
  } catch(e) {
    setStatus('error', 'ERROR');
    showToast('Failed to connect to database', 'error');
    console.error(e);
  }
}

// ‚îÄ‚îÄ ROOMS ‚îÄ‚îÄ
function openRoomModal() {
  document.getElementById('roomNameInput').value = '';
  document.getElementById('roomCodeInput').value = '';
  document.getElementById('roomOverlay').classList.add('open');
  setTimeout(() => document.getElementById('roomNameInput').focus(), 50);
}
function closeRoomModal() { document.getElementById('roomOverlay').classList.remove('open'); }
async function submitRoom() {
  const name = document.getElementById('roomNameInput').value.trim();
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!name || !code) return showToast('Fill in both fields', 'error');
  if (rooms.find(r => r.code === code)) return showToast('Code already in use', 'error');
  const btn = document.getElementById('roomSubmitBtn');
  btn.disabled = true;
  try {
    const [newRoom] = await sb('POST', 'rooms', { name, code });
    rooms.push(newRoom);
    render();
    closeRoomModal();
    showToast(`Room "${name}" added`, 'success');
  } catch(e) {
    showToast('Error saving room', 'error');
  }
  btn.disabled = false;
}
async function deleteRoom(id) {
  if (!confirm('Delete this room and all its totes and items?')) return;
  try {
    await sb('DELETE', `rooms?id=eq.${id}`);
    rooms = rooms.filter(r => r.id !== id);
    totes = totes.filter(t => t.room_id !== id);
    items = items.filter(i => !totes.find(t => t.id === i.tote_id) === false);
    // reload items cleanly
    items = await sb('GET', 'items?select=*&order=created_at');
    if (selectedRoom === id) selectedRoom = 'all';
    render();
    showToast('Room deleted', 'success');
  } catch(e) {
    showToast('Error deleting room', 'error');
  }
}

// ‚îÄ‚îÄ TOTES ‚îÄ‚îÄ
function openToteModal() {
  const sel = document.getElementById('toteRoomSel');
  sel.innerHTML = rooms.map(r => `<option value="${r.id}">${r.name} (${r.code})</option>`).join('');
  if (selectedRoom !== 'all') sel.value = selectedRoom;
  document.getElementById('toteNameInput').value = '';
  document.getElementById('toteShelfInput').value = '';
  updateIdPreview();
  document.getElementById('toteOverlay').classList.add('open');
  setTimeout(() => document.getElementById('toteNameInput').focus(), 50);
}
function closeToteModal() { document.getElementById('toteOverlay').classList.remove('open'); }
function updateIdPreview() {
  const roomId = document.getElementById('toteRoomSel').value;
  const room = rooms.find(r => r.id === roomId);
  if (!room) { document.getElementById('idPreview').textContent = 'Select a room first'; return; }
  const existing = totes.filter(t => t.room_id === roomId).length;
  const num = String(existing + 1).padStart(2, '0');
  document.getElementById('idPreview').textContent = `Tote ID: ${room.code}-${num}`;
}
async function submitTote() {
  const roomId = document.getElementById('toteRoomSel').value;
  const room = rooms.find(r => r.id === roomId);
  if (!room) return showToast('Select a room', 'error');
  const existing = totes.filter(t => t.room_id === roomId).length;
  const num = String(existing + 1).padStart(2, '0');
  const toteId = `${room.code}-${num}`;
  const nameVal = document.getElementById('toteNameInput').value.trim();
  const name = nameVal || toteId;
  const shelf = document.getElementById('toteShelfInput').value.trim();
  const btn = document.getElementById('toteSubmitBtn');
  btn.disabled = true;
  try {
    const [newTote] = await sb('POST', 'totes', { id: toteId, room_id: roomId, name, shelf: shelf || null });
    totes.push(newTote);
    render();
    closeToteModal();
    showToast(`Tote ${toteId} created`, 'success');
  } catch(e) {
    showToast('Error creating tote ‚Äî ID may already exist', 'error');
  }
  btn.disabled = false;
}
async function deleteTote(id) {
  if (!confirm(`Delete tote ${id} and all its items?`)) return;
  try {
    await sb('DELETE', `totes?id=eq.${encodeURIComponent(id)}`);
    totes = totes.filter(t => t.id !== id);
    items = items.filter(i => i.tote_id !== id);
    render();
    showToast(`Tote ${id} deleted`, 'success');
  } catch(e) {
    showToast('Error deleting tote', 'error');
  }
}

// ‚îÄ‚îÄ ITEMS ‚îÄ‚îÄ
async function addItem(toteId) {
  const input = document.getElementById(`ii-${toteId}`);
  const catSel = document.getElementById(`ic-${toteId}`);
  const name = input.value.trim();
  if (!name) return;
  input.disabled = true;
  try {
    const [newItem] = await sb('POST', 'items', { tote_id: toteId, name, category: catSel.value });
    items.push(newItem);
    input.value = '';
    render();
    setTimeout(() => { const el = document.getElementById(`ii-${toteId}`); if (el) el.focus(); }, 30);
  } catch(e) {
    showToast('Error adding item', 'error');
  }
  input.disabled = false;
}
async function removeItem(itemId) {
  try {
    await sb('DELETE', `items?id=eq.${itemId}`);
    items = items.filter(i => i.id !== itemId);
    render();
  } catch(e) {
    showToast('Error removing item', 'error');
  }
}

// ‚îÄ‚îÄ SELECT ROOM ‚îÄ‚îÄ
function selectRoom(id) {
  selectedRoom = id;
  searchQuery = '';
  document.getElementById('searchInput').value = '';
  render();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function hl(text, q) {
  if (!q) return esc(text);
  const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
  return esc(text).replace(re, '<mark>$1</mark>');
}
function setStatus(type, label) {
  const dot = document.getElementById('statusDot');
  const lbl = document.getElementById('statusLabel');
  dot.className = 'status-dot' + (type !== 'ok' ? ' ' + type : '');
  lbl.textContent = label;
}
let toastTimer;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.className = 'toast', 2800);
}
function catSelect(toteId) {
  return `<select class="cat-sel" id="ic-${toteId}">
    ${Object.entries(CATEGORIES).map(([k,v]) => `<option value="${k}">${v.label}</option>`).join('')}
  </select>`;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render() {
  // Stats
  document.getElementById('statRooms').textContent = rooms.length;
  document.getElementById('statTotes').textContent = totes.length;
  document.getElementById('statItems').textContent = items.length;
  document.getElementById('allCount').textContent = totes.length;

  // Sidebar nav
  document.getElementById('navAll').className = 'nav-item' + (selectedRoom === 'all' ? ' active' : '') + ' ';
  document.getElementById('navAll').style.cssText = 'border-bottom:1px solid var(--border);font-weight:600;' + (selectedRoom === 'all' ? 'border-left:2px solid var(--accent);background:var(--surface2);' : '');

  document.getElementById('roomsNav').innerHTML = rooms.map(r => {
    const count = totes.filter(t => t.room_id === r.id).length;
    return `<div class="nav-item ${selectedRoom === r.id ? 'active' : ''}" onclick="selectRoom('${r.id}')">
      <span class="nav-label">${esc(r.name)}</span>
      <span class="nav-count">${count}</span>
      <span class="nav-code">${esc(r.code)}</span>
      <button class="nav-del" onclick="event.stopPropagation();deleteRoom('${r.id}')" title="Delete">√ó</button>
    </div>`;
  }).join('');

  // Cat legend
  document.getElementById('catLegend').innerHTML = Object.entries(CATEGORIES).map(([k,v]) =>
    `<span class="cat-pill"><span class="cat-dot-sm" style="background:${v.color}"></span>${v.label}</span>`
  ).join('');

  const main = document.getElementById('mainArea');
  const q = searchQuery.toLowerCase().trim();

  // ‚îÄ‚îÄ SEARCH MODE ‚îÄ‚îÄ
  if (q) {
    const results = [];
    items.forEach(item => {
      if (item.name.toLowerCase().includes(q)) {
        const tote = totes.find(t => t.id === item.tote_id);
        const room = tote ? rooms.find(r => r.id === tote.room_id) : null;
        results.push({ item, tote, room });
      }
    });
    main.innerHTML = `
      <div class="page-header">
        <div>
          <div class="page-title">Search Results</div>
          <div class="page-sub">${results.length} ITEM${results.length !== 1 ? 'S' : ''} MATCHING "${esc(searchQuery).toUpperCase()}"</div>
        </div>
      </div>
      <div class="search-results">
        ${!results.length ? `<div class="empty-state"><div class="empty-icon">üîç</div><h3>Nothing Found</h3><p>No items match that search.</p></div>` :
          results.map(({item, tote, room}) => {
            const cat = CATEGORIES[item.category] || CATEGORIES.other;
            return `<div class="sr-card">
              <span class="cat-dot-sm" style="width:8px;height:8px;border-radius:50%;background:${cat.color};flex-shrink:0"></span>
              <span class="sr-item-name">${hl(item.name, searchQuery)}</span>
              ${tote ? `<span class="sr-tote-name">${esc(tote.name)}</span>` : ''}
              ${tote ? `<span class="sr-loc">${esc(tote.id)}${tote.shelf ? ' ¬∑ '+esc(tote.shelf) : ''}</span>` : ''}
              ${room ? `<span class="sr-shelf">${esc(room.name)}</span>` : ''}
            </div>`;
          }).join('')
        }
      </div>`;
    return;
  }

  // ‚îÄ‚îÄ NORMAL VIEW ‚îÄ‚îÄ
  const filteredTotes = selectedRoom === 'all'
    ? totes
    : totes.filter(t => t.room_id === selectedRoom);

  const room = rooms.find(r => r.id === selectedRoom);
  const titleText = selectedRoom === 'all' ? 'All Totes' : (room?.name || 'Totes');

  if (!rooms.length) {
    main.innerHTML = `<div class="empty-state"><div class="empty-icon">üè†</div><h3>Start Here</h3><p>Add your first room using the <b>+</b> button in the sidebar.</p></div>`;
    return;
  }

  main.innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">${esc(titleText)}</div>
        <div class="page-sub">${filteredTotes.length} TOTE${filteredTotes.length !== 1 ? 'S' : ''}${selectedRoom !== 'all' && room ? ' ¬∑ CODE: ' + esc(room.code) : ' ¬∑ ' + rooms.length + ' ROOMS'}</div>
      </div>
      <button class="btn-primary" onclick="openToteModal()">+ Add Tote</button>
    </div>
    ${!filteredTotes.length
      ? `<div class="empty-state"><div class="empty-icon">üì¶</div><h3>No Totes Yet</h3><p>Click <b>+ Add Tote</b> to create your first container.</p></div>`
      : `<div class="tote-grid">${filteredTotes.map(tote => {
          const toteItems = items.filter(i => i.tote_id === tote.id);
          const roomObj = rooms.find(r => r.id === tote.room_id);
          return `<div class="tote-card">
            <div class="tote-card-head">
              <span class="tote-badge">${esc(tote.id)}</span>
              <span class="tote-title" title="${esc(tote.name)}">${esc(tote.name)}</span>
              <span class="tote-meta">${toteItems.length} item${toteItems.length !== 1 ? 's' : ''}</span>
            </div>
            <div class="tote-card-sub">
              <span>üìç ${tote.shelf ? esc(tote.shelf) : 'No location set'}${selectedRoom === 'all' && roomObj ? ' ¬∑ ' + esc(roomObj.name) : ''}</span>
              <button class="tote-del-btn" onclick="deleteTote('${esc(tote.id)}')" title="Delete tote">Delete</button>
            </div>
            <div class="tote-body">
              <div class="items-wrap">
                ${toteItems.map(item => {
                  const cat = CATEGORIES[item.category] || CATEGORIES.other;
                  return `<span class="item-chip">
                    <span class="chip-dot" style="background:${cat.color}"></span>
                    ${esc(item.name)}
                    <button class="chip-del" onclick="removeItem('${item.id}')" title="Remove">√ó</button>
                  </span>`;
                }).join('')}
              </div>
              <div class="add-item-row">
                <input class="item-text-input" id="ii-${tote.id}" placeholder="Add item..."
                  onkeydown="if(event.key==='Enter') addItem('${esc(tote.id)}')">
                ${catSelect(tote.id)}
                <button class="btn-add-item" onclick="addItem('${esc(tote.id)}')">ADD</button>
              </div>
            </div>
          </div>`;
        }).join('')}</div>`
    }`;
}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
document.getElementById('searchInput').addEventListener('input', function() {
  searchQuery = this.value;
  render();
});
document.getElementById('roomOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeRoomModal(); });
document.getElementById('toteOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeToteModal(); });
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeRoomModal(); closeToteModal(); }
});
document.getElementById('roomNameInput').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('roomCodeInput').focus(); });
document.getElementById('roomCodeInput').addEventListener('keydown', e => { if (e.key === 'Enter') submitRoom(); });

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadAll();
</script>
</body>
</html>
